import{_ as D,u as I,b as K,i as U,r as n,I as z,U as A,f as F,j as k,o as l,c as u,a,k as d,w as _,l as p,x,F as O,p as N,C as L,D as G,E as P,T as Q,q as X,m as h,H as Y}from"./index-78te5h-u.js";const e={url:"",websocket:null,websocketState:!0,reconnectNum:0,lockReconnect:!1,timeout:null,clientTimeout:null,serverTimeout:null,connection_error:!1,initWebSocket(c){e.url=c,e.websocket=new WebSocket(e.url),e.websocket.onopen=e.websocketOnOpen,e.websocket.onerror=e.websocketOnError,e.websocket.onclose=e.websocketOnClose,this.resetHeartbeat()},reconnect(){if(!e.lockReconnect){if(e.reconnectNum+=1,e.reconnectNum===3){e.reconnectNum=0,e.websocket.onclose();return}e.lockReconnect=!0,e.timeout=setTimeout(()=>{e.initWebSocket(e.url),e.lockReconnect=!1},5e3)}},resetHeartbeat(){e.heartbeat()},heartbeat(){e.clientTimeout=setTimeout(()=>{e.websocket&&(e.websocket.send(JSON.stringify({type:"heartbeat"})),e.websocketState=!1,e.serverTimeout=setTimeout(()=>{e.websocketState?this.resetHeartbeat():e.websocket.onclose()},60*1e3))},3*1e3)},sendMsg(c){e.websocket.send(c)},websocketOnOpen(c){e.sendMsg(JSON.stringify({type:"heartbeat"}))},websocketOnError(c){console.log(c),this.connection_error=!0,e.reconnect()},websocketOnClose(){e.websocket.close()}},Z={class:"body"},ee={style:{position:"absolute",top:"200px",width:"200px"}},te={class:"container"},oe={key:0,class:"connection_ready"},se={class:"messages",id:"messages"},ne={class:"message-container"},ae={key:0,class:"error"},ce={class:"send-zone"},re=["onKeyup"],le={__name:"Chat",setup(c){const R=I(),w=K(),g=U("notification"),v=n([]),f=n(!1),y=n(!1),E=n("dd"),m=n(""),H=n("demo"),i=n(w.query.token),C=n([]);C.value=[{userid:"24",username:"jwc"},{userid:"5",username:"jwcc"}];const{token:T,username:M}=z(A());console.log(T.value,"-----------",M.value);const B=()=>{var s=`ws://121.41.177.252:8888/websocket/${H.value}?token=${w.query.token}`;e.initWebSocket(s),f.value=e.websocketState,console.log(f.value),y.value=e.connection_error,e.websocket.onmessage=J},J=s=>{var t=JSON.parse(s.data);if(t.type=="message"){v.value.push({type:"message",from:"other",message:t.message,to:i.value,receivetime:t.time});const r=document.getElementById("messages");r.scrollTo({top:r.scrollHeight,behavior:"smooth"})}e.websocketState=!0},V=()=>{var s={type:"message",from:E.value,message:m.value,to:i.value};e.sendMsg(JSON.stringify(s)),v.value.push({type:"message",from:"me",message:m.value,to:i.value}),m.value=""},$=s=>{i.value=s,console.log("选中的是",i.value);let t=3;const r=g.create({title:"连接成功",content:` ${t} 秒后自动关闭`,duration:1e4,closable:!1,onAfterEnter:()=>{const b=()=>{t--,r.content=`${t} 秒后自动关闭`,t>0&&window.setTimeout(b,1e3)};window.setTimeout(b,1e3)},onAfterLeave:()=>{g.create({title:"欢迎"+i.value+"聊天",content:"这其实连个冷笑话都算不上",duration:1e4})}})},j=()=>{R.push({path:"/",query:{token:T.value}})};return F(()=>{B()}),(s,t)=>{const r=k("n-button"),b=k("n-tab-pane"),q=k("n-tabs"),W=k("n-space");return l(),u("body",Z,[a("div",ee,[d(W,{vertical:""},{default:_(()=>[d(q,{type:"card",placement:"left",animated:"",style:{height:"240px"}},{default:_(()=>[d(Q),(l(!0),u(O,null,N(C.value,(o,S)=>(l(),X(b,{name:o.username,tab:o.username},{default:_(()=>[p(" Hey Jude"+h(o.userid)+" ",1),d(r,{onClick:ie=>$(o.userid)},{default:_(()=>[p(" 点击聊天 ")]),_:2},1032,["onClick"])]),_:2},1032,["name","tab"]))),256))]),_:1})]),_:1})]),a("div",te,[d(r,{type:"info",dashed:"",onClick:j},{default:_(()=>[p(" 退出聊天 ")]),_:1}),a("h1",null,[p("聊天室 - "),f.value?(l(),u("span",oe,"Connection ready!")):x("",!0)]),a("div",se,[a("div",ne,[y.value?(l(),u("h1",ae," Connection error! ")):x("",!0),(l(!0),u(O,null,N(v.value,(o,S)=>(l(),u("div",{key:"m-"+S,style:{clear:"both"}},[a("div",{class:Y({"msg-from-me":o.from=="me","msg-from-other":o.from=="other"})},h(o.message)+" "+h(o.receivetime),3)]))),128))])]),a("div",ce,[L(a("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),type:"text",placeholder:"Type a message",onKeyup:P(V,["enter"])},null,40,re),[[G,m.value]])])])])}}},me=D(le,[["__scopeId","data-v-dc0d1d4e"]]);export{me as default};
